{% extends "base.html" %}

{% block title %}–ö–∞—Ä—Ç–∞ –∑–∞–≥—Ä—è–∑–Ω–µ–Ω–∏–π - –ß–∏—Å—Ç—ã–π –ê–ª–º–∞—Ç—ã{% endblock %}

{% block extra_css %}
<style>
    .map-page {
        min-height: calc(100vh - 80px);
        display: flex;
        flex-direction: column;
        background: linear-gradient(135deg, #f3f8ff 0%, #f5fff4 100%);
    }

    .map-hero {
        padding: 2.5rem 2rem 1.5rem;
        display: grid;
        grid-template-columns: 1.2fr 0.8fr;
        gap: 2rem;
    }

    .map-hero-card {
        background: white;
        border-radius: 28px;
        padding: 2rem;
        box-shadow: 0 25px 60px rgba(29, 78, 216, 0.08);
        position: relative;
        overflow: hidden;
        isolation: isolate;
    }

    .map-hero-card::after {
        content: '';
        position: absolute;
        inset: 0;
        background: radial-gradient(circle at bottom right, rgba(105, 240, 174, 0.3), transparent 50%);
        z-index: -1;
    }

    .map-hero-card .eyebrow {
        font-weight: 700;
        color: #25c681;
        text-transform: uppercase;
        letter-spacing: 0.2em;
        font-size: 0.8rem;
    }

    .map-hero-card h1 {
        margin: 0.5rem 0 1rem;
        font-size: 2.6rem;
        color: var(--graphite);
        line-height: 1.2;
    }

    .map-hero-card p {
        color: #637083;
        font-size: 1.05rem;
        margin-bottom: 1.5rem;
    }

    .hero-actions {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
    }

    .hero-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.85rem 1.5rem;
        border-radius: 16px;
        font-weight: 600;
        border: none;
        cursor: pointer;
        transition: transform 0.3s, box-shadow 0.3s;
        font-size: 0.95rem;
        text-decoration: none;
    }

    .hero-btn.primary {
        background: linear-gradient(120deg, #2ecc71, #1abc9c);
        color: white;
        box-shadow: 0 15px 30px rgba(46, 204, 113, 0.3);
    }

    .hero-btn.secondary {
        background: rgba(46, 204, 113, 0.12);
        color: #199068;
    }

    .hero-btn:hover {
        transform: translateY(-2px);
    }

    .map-hero-card.stats {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 1rem;
    }

    .stat-pill {
        background: #f9fbff;
        border-radius: 20px;
        padding: 1rem 1.2rem;
        border: 1px solid rgba(99, 112, 131, 0.08);
    }

    .stat-pill strong {
        display: block;
        font-size: 2rem;
        color: var(--graphite);
        line-height: 1.1;
    }

    .stat-pill span {
        color: #6e7b90;
        font-size: 0.9rem;
    }

    .map-toolbar {
        background: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        margin: 0 2rem 1.5rem;
        padding: 1rem 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 1rem;
        box-shadow: 0 20px 45px rgba(35, 78, 90, 0.08);
    }

    .map-filters {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
    }

    .filter-btn {
        padding: 0.65rem 1.3rem;
        border: 1px solid rgba(22, 101, 216, 0.1);
        background: white;
        border-radius: 999px;
        cursor: pointer;
        transition: all 0.3s;
        font-weight: 600;
        font-size: 0.9rem;
        color: #4b5563;
        display: inline-flex;
        align-items: center;
        gap: 0.45rem;
        box-shadow: inset 0 0 0 1px rgba(99, 102, 241, 0.05);
    }

    .filter-btn i {
        font-size: 1rem;
    }

    .filter-btn:hover,
    .filter-btn.active {
        border-color: #1abc9c;
        background: rgba(26, 188, 156, 0.12);
        color: #0e8f72;
        box-shadow: 0 10px 20px rgba(16, 185, 129, 0.2);
    }

    .toolbar-actions {
        display: flex;
        gap: 0.8rem;
        flex-wrap: wrap;
    }

    .toolbar-btn {
        border-radius: 14px;
        padding: 0.65rem 1.2rem;
        border: none;
        font-weight: 600;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        text-decoration: none;
    }

    .toolbar-btn.neutral {
        background: rgba(15, 23, 42, 0.06);
        color: #1f2937;
    }

    .toolbar-btn.cta {
        background: linear-gradient(120deg, #ff5f6d, #ffc371);
        color: white;
        box-shadow: 0 15px 35px rgba(255, 95, 109, 0.35);
    }

    .map-wrapper {
        position: relative;
        flex: 1;
        margin: 0 2rem 2rem;
        border-radius: 32px;
        overflow: hidden;
        box-shadow: 0 30px 60px rgba(15, 23, 42, 0.15);
        background: white;
    }

    .map-container {
        height: calc(100vh - 320px);
        min-height: 420px;
        position: relative;
    }

    #fullMap {
        width: 100%;
        height: 100%;
    }

    .legend {
        background: rgba(15, 23, 42, 0.8);
        color: white;
        padding: 1.4rem;
        border-radius: 18px;
        position: absolute;
        bottom: 30px;
        right: 30px;
        z-index: 1000;
        min-width: 220px;
        backdrop-filter: blur(6px);
    }

    .legend h4 {
        margin: 0 0 0.8rem;
        font-size: 1rem;
        letter-spacing: 0.04em;
        text-transform: uppercase;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 0.9rem;
        margin-bottom: 0.7rem;
        font-weight: 500;
    }

    .legend-color {
        width: 28px;
        height: 28px;
        border-radius: 10px;
        border: 2px solid rgba(255, 255, 255, 0.4);
        box-shadow: 0 10px 18px rgba(0, 0, 0, 0.2);
    }

    .map-info-card {
        position: absolute;
        top: 30px;
        left: 30px;
        z-index: 1000;
        background: rgba(255, 255, 255, 0.9);
        padding: 1.2rem 1.4rem;
        border-radius: 18px;
        backdrop-filter: blur(10px);
        box-shadow: 0 20px 35px rgba(15, 23, 42, 0.15);
        max-width: 320px;
    }

    .map-info-card h4 {
        margin: 0 0 0.5rem;
        font-size: 1.05rem;
        color: var(--graphite);
    }

    .map-info-card p {
        margin: 0;
        color: #607189;
        font-size: 0.95rem;
    }

    .custom-marker {
        background: transparent !important;
        border: none !important;
    }
    
    .custom-marker div {
        display: block !important;
    }

    .leaflet-popup-content-wrapper {
        border-radius: 20px;
        box-shadow: 0 20px 50px rgba(15, 23, 42, 0.2);
        border: 1px solid rgba(226, 232, 240, 0.8);
        padding: 0;
        overflow: hidden;
    }

    .leaflet-popup-content {
        margin: 0;
        padding: 0;
        width: auto !important;
    }

    .leaflet-container a.leaflet-popup-close-button {
        color: #64748b;
        font-size: 1.5rem;
        padding: 8px;
        transition: color 0.2s;
    }

    .leaflet-container a.leaflet-popup-close-button:hover {
        color: #1f2937;
    }

    .clean-popup .leaflet-popup-content-wrapper {
        background: white;
    }

    .empty-state {
        position: absolute;
        inset: 0;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 0.8rem;
        color: #455066;
        font-weight: 600;
        text-align: center;
        padding: 2rem;
        z-index: 500;
        display: none;
    }

    .empty-state.show {
        display: flex;
    }

    @media (max-width: 1100px) {
        .map-hero {
            grid-template-columns: 1fr;
        }

        .map-toolbar {
            flex-direction: column;
            align-items: flex-start;
        }

        .map-wrapper {
            margin: 0 1.5rem 1.5rem;
        }
    }

    @media (max-width: 768px) {
        .map-hero {
            padding: 1.5rem;
        }

        .map-hero-card {
            padding: 1.5rem;
        }

        .map-hero-card h1 {
            font-size: 2rem;
        }

        .map-toolbar {
            margin: 0 1.5rem 1rem;
        }

        .map-wrapper {
            margin: 0 1rem 1.5rem;
        }

        .map-container {
            height: 65vh;
        }

        .legend,
        .map-info-card {
            position: relative;
            inset: auto;
            margin: 1rem;
        }

        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 0.8rem;
        }

        .empty-state {
            font-size: 0.9rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="map-page">
    <section class="map-hero">
        <div class="map-hero-card">
            <p class="eyebrow">–≥–æ—Ä–æ–¥—Å–∫–∞—è —ç–∫–æ—Å–∏—Å—Ç–µ–º–∞</p>
            <h1>–ö–∞—Ä—Ç–∞ –∑–∞–≥—Ä—è–∑–Ω–µ–Ω–∏–π –ê–ª–º–∞—Ç—ã</h1>
            <p>
                –°–ª–µ–¥–∏–º –∑–∞ —á–∏—Å—Ç–æ—Ç–æ–π —Ä–∞–π–æ–Ω–æ–≤, –æ—Ç–º–µ—á–∞–µ–º –ø—Ä–æ–±–ª–µ–º–Ω—ã–µ —Ç–æ—á–∫–∏ –∏ —Ñ–∏–∫—Å–∏—Ä—É–µ–º —É—Å–ø–µ—Ö–∏ –æ—á–∏—Å—Ç–∫–∏.
                –í—ã–±–µ—Ä–∏—Ç–µ –Ω—É–∂–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ —Å–≤–æ—ë –Ω–∞–±–ª—é–¥–µ–Ω–∏–µ ‚Äî –≤–º–µ—Å—Ç–µ –º—ã —É—Å–∫–æ—Ä–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏—è.
            </p>
            <div class="hero-actions">
                <a href="{{ url_for('reports.new_report') }}" class="hero-btn primary">
                    <i class="bi bi-camera-fill"></i> –°–æ–æ–±—â–∏—Ç—å –æ –ø—Ä–æ–±–ª–µ–º–µ
                </a>
                <a href="{{ url_for('main.leaderboard') }}" class="hero-btn secondary">
                    <i class="bi bi-trophy-fill"></i> –õ–∏–¥–µ—Ä–±–æ—Ä–¥
                </a>
            </div>
        </div>
        <div class="map-hero-card stats">
            <div class="stat-pill">
                <strong>{{ stats.total_reports }}</strong>
                <span>–≤—Å–µ–≥–æ —Ä–µ–ø–æ—Ä—Ç–æ–≤</span>
            </div>
            <div class="stat-pill">
                <strong>{{ stats.confirmed }}</strong>
                <span>–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ</span>
            </div>
            <div class="stat-pill">
                <strong>{{ stats.cleaned }}</strong>
                <span>—É–±—Ä–∞–Ω–æ</span>
            </div>
            <div class="stat-pill">
                <strong>{{ stats.pending }}</strong>
                <span>–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ</span>
            </div>
        </div>
    </section>

    <div class="map-toolbar">
        <div class="map-filters">
            <button class="filter-btn active" data-filter="all" onclick="filterReports('all', this)">
                <i class="bi bi-globe2"></i>
                –í—Å–µ <span id="count-all">({{ stats.total_reports }})</span>
            </button>
            <button class="filter-btn" data-filter="confirmed" onclick="filterReports('confirmed', this)">
                <i class="bi bi-shield-check"></i>
                –ü–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω–Ω—ã–µ <span id="count-confirmed">({{ stats.confirmed }})</span>
            </button>
            <button class="filter-btn" data-filter="cleaned" onclick="filterReports('cleaned', this)">
                <i class="bi bi-stars"></i>
                –£–±—Ä–∞–Ω–Ω—ã–µ <span id="count-cleaned">({{ stats.cleaned }})</span>
            </button>
            <button class="filter-btn" data-filter="pending" onclick="filterReports('pending', this)">
                <i class="bi bi-hourglass-split"></i>
                –ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ <span id="count-pending">({{ stats.pending }})</span>
            </button>
        </div>
        <div class="toolbar-actions">
            <button class="toolbar-btn neutral" onclick="map.setView([43.2220, 76.8512], 12)">
                <i class="bi bi-compass"></i> –¶–µ–Ω—Ç—Ä –ê–ª–º–∞—Ç—ã
            </button>
            <a href="{{ url_for('reports.new_report') }}" class="toolbar-btn cta">
                <i class="bi bi-plus-lg"></i> –î–æ–±–∞–≤–∏—Ç—å —Ä–µ–ø–æ—Ä—Ç
            </a>
        </div>
    </div>

    <div class="map-wrapper">
        <div class="map-container">
            <div id="fullMap"></div>
            <div class="empty-state" id="emptyState">
                <i class="bi bi-emoji-smile" style="font-size:2rem;"></i>
                –í —ç—Ç–æ–º —Ñ–∏–ª—å—Ç—Ä–µ –ø–æ–∫–∞ –Ω–µ—Ç —Ä–µ–ø–æ—Ä—Ç–æ–≤. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–æ–π —Å—Ç–∞—Ç—É—Å.
            </div>
            <div class="legend">
                <h4>–õ–µ–≥–µ–Ω–¥–∞</h4>
                <div class="legend-item">
                    <div class="legend-color" style="background: #E53935; width: 20px; height: 20px; border: 3px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.4);"></div>
                    <span>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #66BB6A; width: 20px; height: 20px; border: 3px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.4);"></div>
                    <span>–£–±—Ä–∞–Ω–æ</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #FFB300; width: 20px; height: 20px; border: 3px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.4);"></div>
                    <span>–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #9E9E9E; width: 20px; height: 20px; border: 3px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.4);"></div>
                    <span>–û—Ç–∫–ª–æ–Ω–µ–Ω–æ</span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // –ì—Ä–∞–Ω–∏—Ü—ã –ê–ª–º–∞—Ç—ã (—Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ)
    const ALMATY_CENTER = [43.2220, 76.8512];
    const ALMATY_BOUNDS = [[42.8, 76.4], [43.5, 77.3]];
    
    // Initialize map centered on Almaty
    const map = L.map('fullMap').setView(ALMATY_CENTER, 12);
    
    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–∞—Ä—Ç—É –≥—Ä–∞–Ω–∏—Ü–∞–º–∏ –ê–ª–º–∞—Ç—ã (–º—è–≥–∫–∏–µ –≥—Ä–∞–Ω–∏—Ü—ã)
    map.setMaxBounds(ALMATY_BOUNDS);
    map.setMinZoom(10);
    
    // Add tile layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
        maxZoom: 19
    }).addTo(map);
    
    let markers = [];
    let allReports = [];
    const emptyState = document.getElementById('emptyState');
    
    // Load reports
    async function loadReports(status = '') {
        try {
            const url = status ? `/api/reports?status=${status}` : '/api/reports';
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            allReports = data.reports || [];
            console.log(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${allReports.length} —Ä–µ–ø–æ—Ä—Ç–æ–≤`);
            
            // –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞—Ö
            if (allReports.length > 0) {
                const coords = allReports.map(r => ({lat: r.latitude, lon: r.longitude}));
                console.log('–ü—Ä–∏–º–µ—Ä—ã –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç:', coords.slice(0, 5));
                const latRange = [Math.min(...coords.map(c => c.lat)), Math.max(...coords.map(c => c.lat))];
                const lonRange = [Math.min(...coords.map(c => c.lon)), Math.max(...coords.map(c => c.lon))];
                console.log(`–î–∏–∞–ø–∞–∑–æ–Ω –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç: lat [${latRange[0]}, ${latRange[1]}], lon [${lonRange[0]}, ${lonRange[1]}]`);
            }
            
            displayReports(allReports);
        } catch (error) {
            console.error('Error loading reports:', error);
            emptyState.classList.add('show');
        }
    }
    
    // Display reports on map
    function displayReports(reports) {
        // Clear existing markers
        markers.forEach(marker => map.removeLayer(marker));
        markers = [];
        
        if (reports.length === 0) {
            emptyState.classList.add('show');
            return;
        }
        
        emptyState.classList.remove('show');
        
        let markersAdded = 0;
        let markersSkipped = 0;
        
        // –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ –º–∞—Ä–∫–µ—Ä—ã –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ (—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è —É–∂–µ –≤ API)
        reports.forEach(report => {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
            if (!report.latitude || !report.longitude || 
                isNaN(report.latitude) || isNaN(report.longitude)) {
                console.warn('–ü—Ä–æ–ø—É—â–µ–Ω —Ä–µ–ø–æ—Ä—Ç —Å –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–º–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏:', report.id);
                markersSkipped++;
                return;
            }
            
            // Determine marker color based on status - –ø—Ä–æ—Å—Ç—ã–µ —è—Ä–∫–∏–µ —Ü–≤–µ—Ç–∞
            let color = '#E53935'; // red for confirmed
            let statusText = '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ';
            if (report.status === 'cleaned') {
                color = '#66BB6A'; // green
                statusText = '–£–±—Ä–∞–Ω–æ';
            }
            if (report.status === 'pending') {
                color = '#FFB300'; // yellow
                statusText = '–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ';
            }
            if (report.status === 'rejected') {
                color = '#9E9E9E'; // gray
                statusText = '–û—Ç–∫–ª–æ–Ω–µ–Ω–æ';
            }
            
            const confidence = report.ai_confidence ? `${Math.round(report.ai_confidence * 100)}%` : '‚Äî';
            const author = report.author || (report.is_anonymous ? '–ê–Ω–æ–Ω–∏–º' : '–ê–Ω–æ–Ω–∏–º');
            const reportCategory = report.report_category || report.trash_type || 'trash';
            
            // –ù–∞–∑–≤–∞–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º
            const categoryNames = {
                'trash': 'üóëÔ∏è –ú—É—Å–æ—Ä',
                'vandalism': 'üé® –í–∞–Ω–¥–∞–ª–∏–∑–º',
                'nature_damage': 'üå≥ –ü–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–µ –ø—Ä–∏—Ä–æ–¥—ã',
                'illegal_dumping': 'üöõ –ù–µ–∑–∞–∫–æ–Ω–Ω—ã–π —Å–±—Ä–æ—Å',
                'construction_waste': 'üèóÔ∏è –°—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω—ã–π –º—É—Å–æ—Ä',
                'hazardous_waste': '‚ö†Ô∏è –û–ø–∞—Å–Ω—ã–µ –æ—Ç—Ö–æ–¥—ã',
                'other': 'üìã –î—Ä—É–≥–æ–µ'
            };
            const categoryName = categoryNames[reportCategory] || 'üìã –î—Ä—É–≥–æ–µ';
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º –ø—É—Ç—å –∫ —Ñ–æ—Ç–æ
            // –î–ª—è —Ç–µ—Å—Ç–æ–≤—ã—Ö —Ä–µ–ø–æ—Ä—Ç–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º –±—É—Ñ–µ—Ä–Ω–æ–µ —Ñ–æ—Ç–æ image.png
            let photoPath = null;
            if (report.photo_url) {
                photoPath = report.photo_url;
            } else if (report.photo_path) {
                if (report.photo_path.startsWith('http')) {
                    photoPath = report.photo_path;
                } else if (report.photo_path === 'image.png') {
                    // –ë—É—Ñ–µ—Ä–Ω–æ–µ —Ñ–æ—Ç–æ –¥–ª—è —Ç–µ—Å—Ç–æ–≤—ã—Ö —Ä–µ–ø–æ—Ä—Ç–æ–≤
                    photoPath = `/static/image.png`;
                } else if (report.photo_path.startsWith('uploads/')) {
                    photoPath = `/static/${report.photo_path}`;
                } else {
                    photoPath = `/static/uploads/${report.photo_path}`;
                }
            } else {
                // –ï—Å–ª–∏ —Ñ–æ—Ç–æ –Ω–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º –±—É—Ñ–µ—Ä–Ω–æ–µ —Ñ–æ—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                photoPath = `/static/image.png`;
            }
            
            // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É
            const createdDate = report.created_at ? new Date(report.created_at).toLocaleDateString('ru-RU', {
                day: 'numeric',
                month: 'short',
                year: 'numeric'
            }) : '‚Äî';

            // –ü—Ä–æ—Å—Ç–æ–π —Ü–≤–µ—Ç–Ω–æ–π –º–∞—Ä–∫–µ—Ä - –∫—Ä—É–≥–ª–∞—è —Ç–æ—á–∫–∞, —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è
            const icon = L.divIcon({
                className: 'custom-marker',
                html: `<div style="width: 18px; height: 18px; background-color: ${color}; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.4);"></div>`,
                iconSize: [18, 18],
                iconAnchor: [9, 9],
                popupAnchor: [0, -9]
            });
            
            const popupContent = `
                <div style="max-width: 340px; font-family: 'Nunito Sans', sans-serif;">
                    ${photoPath ? `<img src="${photoPath}" style="width: 100%; height: 180px; border-radius: 12px; margin-bottom: 12px; object-fit: cover; cursor: pointer;" onclick="window.open('${photoPath}', '_blank')" onerror="this.style.display='none'">` : ''}
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
                        <div style="width: 12px; height: 12px; border-radius: 50%; background-color: ${color}; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.2);"></div>
                        <h4 style="margin: 0; font-size: 1.15rem; color: #0f172a; font-weight: 700;">${report.district || '–ê–ª–º–∞—Ç—ã'}</h4>
                    </div>
                    ${report.address ? `<p style="margin: 0 0 10px 0; color: #64748b; font-size: 0.9rem;"><i class="bi bi-geo-alt"></i> ${report.address}</p>` : ''}
                    ${report.description ? `<p style="margin: 0 0 12px 0; color: #475569; line-height: 1.5;">${report.description}</p>` : ''}
                    <div style="background: #f8fafc; border-radius: 10px; padding: 12px; margin-bottom: 12px; font-size: 0.9rem; color: #475569;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                            <div><strong>–°—Ç–∞—Ç—É—Å:</strong><br>${getStatusText(report.status)}</div>
                            <div><strong>–¢–∏–ø –Ω–∞—Ä—É—à–µ–Ω–∏—è:</strong><br>${categoryName}</div>
                            <div><strong>AI –¥–æ—Å—Ç–æ–≤–µ—Ä–Ω–æ—Å—Ç—å:</strong><br>${confidence}</div>
                            <div><strong>–î–∞—Ç–∞:</strong><br>${createdDate}</div>
                        </div>
                        <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #e2e8f0;">
                            <strong>–ê–≤—Ç–æ—Ä:</strong> ${author}
                        </div>
                    </div>
                    <a href="/report/${report.id}" style="display: inline-flex; align-items: center; gap: 6px; margin-top: 8px; padding: 10px 16px; background: linear-gradient(120deg, #2ecc71, #1abc9c); color: white; text-decoration: none; border-radius: 10px; font-weight: 600; font-size: 0.95rem; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                        –ü–æ–¥—Ä–æ–±–Ω–µ–µ <i class="bi bi-arrow-right"></i>
                    </a>
                </div>
            `;
            
            const marker = L.marker([report.latitude, report.longitude], { 
                icon: icon,
                interactive: true
            })
                .addTo(map)
                .bindPopup(popupContent, {
                    className: 'clean-popup',
                    maxWidth: 360,
                    closeButton: true
                });
            
            markers.push(marker);
            markersAdded++;
        });
        
        console.log(`–î–æ–±–∞–≤–ª–µ–Ω–æ –º–∞—Ä–∫–µ—Ä–æ–≤: ${markersAdded}, –ø—Ä–æ–ø—É—â–µ–Ω–æ: ${markersSkipped}`);
        
        // –ï—Å–ª–∏ –µ—Å—Ç—å –º–∞—Ä–∫–µ—Ä—ã, –ø–æ–¥–≥–æ–Ω—è–µ–º –∫–∞—Ä—Ç—É –ø–æ–¥ –Ω–∏—Ö
        if (markers.length > 0) {
            const group = new L.featureGroup(markers);
            if (markers.length === 1) {
                map.setView([markers[0].getLatLng().lat, markers[0].getLatLng().lng], 15);
            } else {
                map.fitBounds(group.getBounds().pad(0.1), { maxZoom: 13 });
            }
            console.log(`–ö–∞—Ä—Ç–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ –Ω–∞ ${markers.length} –º–∞—Ä–∫–µ—Ä–æ–≤`);
        } else {
            console.warn('–ù–µ—Ç –º–∞—Ä–∫–µ—Ä–æ–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è!');
        }
    }
    
    function getStatusText(status) {
        const statusMap = {
            'confirmed': '‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ',
            'cleaned': 'üéâ –£–±—Ä–∞–Ω–æ',
            'pending': '‚è≥ –ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ',
            'rejected': '‚ùå –û—Ç–∫–ª–æ–Ω–µ–Ω–æ'
        };
        return statusMap[status] || status;
    }
    
    // Filter reports
    function filterReports(status, button) {
        document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
        if (button) {
            button.classList.add('active');
        }
        loadReports(status === 'all' ? '' : status);
    }
    
    // Initial load with default filter
    const defaultFilterBtn = document.querySelector('.filter-btn[data-filter="all"]');
    filterReports('all', defaultFilterBtn);
</script>
{% endblock %}

