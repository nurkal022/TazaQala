{% extends "base.html" %}

{% block title %}Призы и награды{% endblock %}

{% block extra_css %}
<style>
    .rewards-page {
        background: linear-gradient(135deg, #f7faff 0%, #f2fff4 100%);
        min-height: calc(100vh - 80px);
        padding-bottom: 4rem;
    }

    .rewards-hero {
        max-width: 1200px;
        margin: 0 auto;
        padding: 3rem 2rem 1.5rem;
        display: grid;
        grid-template-columns: 1.2fr 0.8fr;
        gap: 2rem;
    }

    .hero-card {
        background: white;
        border-radius: 32px;
        padding: 2.5rem;
        position: relative;
        overflow: hidden;
        box-shadow: 0 25px 60px rgba(15, 23, 42, 0.08);
    }

    .hero-card::after {
        content: '';
        position: absolute;
        inset: 0;
        background: radial-gradient(circle at top right, rgba(26, 188, 156, 0.25), transparent 55%);
        z-index: 0;
    }

    .hero-card > * {
        position: relative;
        z-index: 1;
    }

    .hero-card h1 {
        font-size: 2.6rem;
        margin-bottom: 0.8rem;
        color: var(--graphite);
    }

    .hero-card p {
        color: #607189;
        font-size: 1.1rem;
        margin-bottom: 1.5rem;
    }

    .balance-chip {
        display: inline-flex;
        align-items: center;
        gap: 0.6rem;
        background: rgba(26, 188, 156, 0.12);
        color: #0f915d;
        padding: 0.6rem 1.2rem;
        border-radius: 999px;
        font-weight: 700;
        margin-bottom: 1rem;
    }

    .hero-steps {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 1rem;
    }

    .hero-step {
        background: #f6f9ff;
        border-radius: 18px;
        padding: 1rem;
        border: 1px solid rgba(15, 23, 42, 0.05);
    }

    .hero-step strong {
        display: block;
        margin-bottom: 0.3rem;
    }

    .recent-box {
        background: white;
        border-radius: 28px;
        padding: 2rem;
        box-shadow: 0 20px 45px rgba(15, 23, 42, 0.08);
    }

    .recent-box h3 {
        margin-bottom: 1rem;
    }

    .recent-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.8rem 0;
        border-bottom: 1px solid rgba(99, 112, 131, 0.15);
    }

    .recent-item:last-child {
        border-bottom: none;
    }

    .catalog-section {
        max-width: 1200px;
        margin: 0 auto;
        padding: 1rem 2rem 2rem;
    }

    .catalog-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 1.5rem;
    }

    .reward-card {
        background: white;
        border-radius: 24px;
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
        box-shadow: 0 15px 35px rgba(15, 23, 42, 0.08);
        position: relative;
        overflow: hidden;
    }

    .reward-card.disabled {
        opacity: 0.6;
    }

    .reward-image {
        width: 100%;
        height: 180px;
        border-radius: 18px;
        object-fit: cover;
        background: #f3f6f9;
    }

    .reward-title {
        font-size: 1.2rem;
        font-weight: 700;
    }

    .reward-cost {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        color: #0f915d;
        background: rgba(26, 188, 156, 0.12);
        padding: 0.4rem 0.9rem;
        border-radius: 999px;
        font-weight: 700;
        font-size: 0.95rem;
    }

    .reward-actions {
        margin-top: auto;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 0.8rem;
    }

    .reward-actions button,
    .reward-actions a {
        flex: 1;
        border: none;
        border-radius: 14px;
        padding: 0.8rem 1rem;
        font-weight: 700;
        cursor: pointer;
        transition: transform 0.2s;
    }

    .reward-actions button {
        background: linear-gradient(120deg, #2ecc71, #1abc9c);
        color: white;
        box-shadow: 0 12px 24px rgba(39, 174, 96, 0.25);
    }

    .reward-actions button[disabled] {
        background: #dfe8ef;
        color: #7c8b9c;
        cursor: not-allowed;
        box-shadow: none;
    }

    .empty-catalog {
        text-align: center;
        padding: 3rem;
        color: #607189;
    }

    @media (max-width: 960px) {
        .rewards-hero {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 600px) {
        .rewards-hero,
        .catalog-section {
            padding: 2rem 1.2rem;
        }

        .hero-card {
            padding: 2rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="rewards-page">
    <section class="rewards-hero">
        <div class="hero-card">
            <span class="balance-chip">
                <i class="bi bi-coin"></i>
                Баланс: {{ user_balance }} баллов
            </span>
            <h1>Призы за вклад в чистый город</h1>
            <p>
                Каждый подтверждённый репорт, помощь при уборке и активность на платформе приносят баллы.
                Обменивайте их на реальные призы и цифровые награды от партнёров Taza Qala.
            </p>
            <div class="hero-steps">
                <div class="hero-step">
                    <strong>1. Зарабатывайте</strong>
                    За репорты с фото, GPS и подтверждённые уборки.
                </div>
                <div class="hero-step">
                    <strong>2. Копите</strong>
                    Баллы накапливаются на вашем эко-счёте.
                </div>
                <div class="hero-step">
                    <strong>3. Обменивайте</strong>
                    Выбирайте призы и оставляйте заявку.
                </div>
            </div>
        </div>

        <div class="recent-box">
            <h3><i class="bi bi-award"></i> Последние заявки</h3>
            {% if current_user.is_authenticated and recent_redemptions %}
                {% for redemption in recent_redemptions %}
                    <div class="recent-item">
                        <div>
                            <strong>{{ redemption.reward.title }}</strong>
                            <div style="font-size:0.85rem;color:#6b7688;">
                                {{ redemption.created_at.strftime('%d.%m.%Y') }}
                            </div>
                        </div>
                        <span class="reward-cost">
                            <i class="bi bi-coin"></i> {{ redemption.points_spent }}
                        </span>
                    </div>
                {% endfor %}
            {% else %}
                <p style="color:#7c8b9c;">
                    {% if current_user.is_authenticated %}
                        Вы ещё не оформляли заявки. Выберите приз в каталоге!
                    {% else %}
                        Войдите, чтобы копить баллы и обменивать их на призы.
                    {% endif %}
                </p>
            {% endif %}
        </div>
    </section>

    <section class="catalog-section">
        <h2 style="margin-bottom:1.5rem;">Каталог наград</h2>
        {% if rewards %}
            <div class="catalog-grid">
                {% for reward in rewards %}
                    {% set unavailable = (reward.total_quantity is not none and reward.available_quantity == 0) or not reward.is_active %}
                    <div class="reward-card {% if unavailable %}disabled{% endif %}">
                        {% if reward.image_path %}
                            <img src="{{ url_for('static', filename=reward.image_path) }}" alt="{{ reward.title }}" class="reward-image">
                        {% else %}
                            <div class="reward-image" style="display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg, #e0f2fe 0%, #dcfce7 100%);">
                                {% if reward.category == 'eco' %}
                                    <i class="bi bi-recycle" style="font-size:4rem;color:#16a34a;"></i>
                                {% elif reward.category == 'experience' %}
                                    <i class="bi bi-calendar-event" style="font-size:4rem;color:#2563eb;"></i>
                                {% elif reward.category == 'digital' %}
                                    <i class="bi bi-badge-check" style="font-size:4rem;color:#7c3aed;"></i>
                                {% elif reward.category == 'discount' %}
                                    <i class="bi bi-percent" style="font-size:4rem;color:#ea580c;"></i>
                                {% else %}
                                    <i class="bi bi-gift" style="font-size:4rem;color:#16a34a;"></i>
                                {% endif %}
                            </div>
                        {% endif %}
                        <div class="reward-title">{{ reward.title }}</div>
                        <p style="color:#6b7688;flex:1;">{{ reward.description or 'Описание обновляется' }}</p>
                        <div class="reward-meta" style="display:flex;justify-content:space-between;align-items:center;">
                            <span class="reward-cost"><i class="bi bi-coin"></i> {{ reward.cost_points }}</span>
                            {% if reward.total_quantity %}
                                <small style="color:#7c8b9c;">Осталось: {{ reward.available_quantity }}</small>
                            {% else %}
                                <small style="color:#7c8b9c;">Доступно всегда</small>
                            {% endif %}
                        </div>
                        <div class="reward-actions">
                            {% if current_user.is_authenticated %}
                                <form method="POST" action="{{ url_for('main.redeem_reward', reward_id=reward.id) }}" style="width:100%;">
                                    <button type="submit" {% if unavailable or current_user.points_balance < reward.cost_points %}disabled{% endif %}>
                                        {% if unavailable %}
                                            Нет в наличии
                                        {% elif current_user.points_balance < reward.cost_points %}
                                            Не хватает баллов
                                        {% else %}
                                            Получить приз
                                        {% endif %}
                                    </button>
                                </form>
                            {% else %}
                                <a href="{{ url_for('auth.login') }}" class="btn btn-secondary">Войти</a>
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="empty-catalog">
                <i class="bi bi-gift" style="font-size:2.5rem;"></i>
                <p>Каталог скоро пополнится. Следите за обновлениями!</p>
            </div>
        {% endif %}
    </section>
</div>
{% endblock %}

